<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pain Discovery - Coaching Professionals</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    * { box-sizing: border-box; }
    .spreadsheet-table { border-collapse: collapse; }
    .spreadsheet-table th, .spreadsheet-table td { border: 1px solid #374151; padding: 8px 12px; text-align: left; white-space: nowrap; }
    .spreadsheet-table th { background: #1f2937; position: sticky; top: 0; z-index: 10; font-weight: 600; }
    .spreadsheet-table tr:nth-child(even) { background: #111827; }
    .spreadsheet-table tr:nth-child(odd) { background: #0f172a; }
    .spreadsheet-table tr:hover { background: #1e3a5f; }
    .bar-chart-bar { transition: width 0.5s ease; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ============================================
    // CONFIGURAZIONE
    // ============================================
    const SUPABASE_URL = 'https://mypapayugbufzswtvyhq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cGFwYXl1Z2J1Znpzd3R2eWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MTU2NzAsImV4cCI6MjA4NjE5MTY3MH0.ALNeVlzG4LzQmKukEr3O6JqRt28BZB-bssiz3hUxH8k';
    const ADMIN_PASSWORD = "coach2024";
    // ============================================

    // Icone SVG
    const Icons = {
      ChevronRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>,
      ChevronLeft: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>,
      Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,
      CheckSmall: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg>,
      Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197"/></svg>,
      Target: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
      Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
      Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
      Wrench: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
      MessageCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>,
      Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
      Spinner: () => <svg className="w-10 h-10 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
      Database: () => <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3" strokeWidth={2}/><path strokeWidth={2} d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path strokeWidth={2} d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
      BarChart: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
      Table: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>,
      ArrowLeft: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>,
      Refresh: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
      Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
      Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
      GripVertical: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="9" cy="6" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="18" r="1.5" fill="currentColor"/><circle cx="15" cy="6" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="18" r="1.5" fill="currentColor"/></svg>,
      Share: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>,
      Mail: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
    };

    // Componente grafico a barre orizzontali
    function HorizontalBarChart({ data, title, color }) {
      var maxValue = Math.max.apply(null, data.map(function(d) { return d.value; })) || 1;
      return (
        <div className="bg-gray-800 rounded-xl p-4">
          <h3 className="text-white font-semibold mb-4">{title}</h3>
          <div className="space-y-3">
            {data.map(function(item, i) {
              var percentage = (item.value / maxValue) * 100;
              return (
                <div key={i}>
                  <div className="flex justify-between text-sm mb-1">
                    <span className="text-gray-300 truncate" style={{maxWidth: '70%'}}>{item.label}</span>
                    <span className="text-white font-medium">{item.value}{item.suffix || ''}</span>
                  </div>
                  <div className="h-6 bg-gray-700 rounded-full overflow-hidden">
                    <div 
                      className="h-full rounded-full bar-chart-bar" 
                      style={{ width: percentage + '%', backgroundColor: color || '#10b981' }}
                    />
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Componente grafico a ciambella
    function DonutChart({ data, title }) {
      var total = data.reduce(function(sum, d) { return sum + d.value; }, 0) || 1;
      var colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
      var currentAngle = 0;
      
      return (
        <div className="bg-gray-800 rounded-xl p-4">
          <h3 className="text-white font-semibold mb-4">{title}</h3>
          <div className="flex items-center gap-4">
            <svg viewBox="0 0 100 100" className="w-32 h-32">
              {data.map(function(item, i) {
                var angle = (item.value / total) * 360;
                var startAngle = currentAngle;
                currentAngle += angle;
                
                var x1 = 50 + 40 * Math.cos((startAngle - 90) * Math.PI / 180);
                var y1 = 50 + 40 * Math.sin((startAngle - 90) * Math.PI / 180);
                var x2 = 50 + 40 * Math.cos((startAngle + angle - 90) * Math.PI / 180);
                var y2 = 50 + 40 * Math.sin((startAngle + angle - 90) * Math.PI / 180);
                var largeArc = angle > 180 ? 1 : 0;
                
                return (
                  <path
                    key={i}
                    d={'M 50 50 L ' + x1 + ' ' + y1 + ' A 40 40 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z'}
                    fill={colors[i % colors.length]}
                  />
                );
              })}
              <circle cx="50" cy="50" r="25" fill="#1f2937" />
              <text x="50" y="50" textAnchor="middle" dy="5" fill="white" fontSize="12" fontWeight="bold">{total}</text>
            </svg>
            <div className="flex-1 space-y-1">
              {data.slice(0, 6).map(function(item, i) {
                return (
                  <div key={i} className="flex items-center gap-2 text-sm">
                    <div className="w-3 h-3 rounded-full" style={{ backgroundColor: colors[i % colors.length] }} />
                    <span className="text-gray-300 truncate">{item.label}</span>
                    <span className="text-white ml-auto">{item.value}</span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    function App() {
      // Stati principali
      const [currentSection, setCurrentSection] = useState(0);
      const [answers, setAnswers] = useState({});
      const [submitted, setSubmitted] = useState(false);
      const [allResponses, setAllResponses] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);
      const [connected, setConnected] = useState(false);
      const [updateEmail, setUpdateEmail] = useState('');
      
      // Stati admin
      const [showWelcome, setShowWelcome] = useState(true);
      const [adminMode, setAdminMode] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [adminError, setAdminError] = useState('');
      const [showLoginForm, setShowLoginForm] = useState(false);
      const [adminTab, setAdminTab] = useState('table'); // 'table' o 'charts'

      // Stati drag & drop
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [dragOverIndex, setDragOverIndex] = useState(null);

      // Dati configurazione
      const platforms = [
        { id: 'linkedin_organic', name: 'LinkedIn (organico)' },
        { id: 'linkedin_ads', name: 'LinkedIn Ads/Sales Nav' },
        { id: 'instagram', name: 'Instagram' },
        { id: 'facebook', name: 'Facebook/Gruppi' },
        { id: 'passaparola', name: 'Passaparola/Referral' },
        { id: 'directory', name: 'Directory (ICF, CoachHub)' },
        { id: 'marketplace', name: 'Marketplace (Fiverr, Upwork, ProntoPro)' },
        { id: 'sito_seo', name: 'Sito web + SEO' },
        { id: 'email_mkt', name: 'Email marketing' },
        { id: 'eventi', name: 'Eventi/Networking' },
        { id: 'altro', name: 'Altro' }
      ];

      const frustrationOptions = [
        'Tempo perso in attivit√† amministrative',
        'Difficolt√† a dimostrare progressi ai clienti',
        'Difficolt√† a trovare clienti qualificati',
        'Clienti che interrompono il percorso',
        'Difficolt√† a giustificare i prezzi',
        'Troppi strumenti da gestire'
      ];

      const specializationOptions = [
        'Executive/Leadership',
        'Life coaching',
        'Career coaching',
        'Business coaching',
        'Health & Wellness',
        'Team/Group'
      ];

      // Colonne per la tabella admin
      const tableColumns = [
        { key: 'created_at', label: 'Data', format: function(v) { return v ? new Date(v).toLocaleDateString('it-IT') : '-'; } },
        { key: 'q1_anni', label: 'Anni Exp.' },
        { key: 'q2_clienti', label: 'Clienti/mese' },
        { key: 'q3_specializzazione', label: 'Specializzazione', format: function(v) { return Array.isArray(v) ? v.join(', ') : v || '-'; } },
        { key: 'q4_fatturato', label: '% Aziende' },
        { key: 'q5_obiettivo', label: 'Obiettivo 12m' },
        { key: 'q6_ostacolo', label: 'Ostacolo' },
        { key: 'q11_spesa', label: 'Spesa mensile' },
        { key: 'q13_magico', label: 'Problema magico' },
        { key: 'q14_ricerca', label: 'Ricerca soluzioni' },
        { key: 'q16_intervista', label: 'Intervista' },
        { key: 'q17_email', label: 'Email' }
      ];

      const sections = [
        {
          id: 'profilo', title: 'Profilo', icon: 'Users', description: 'Raccontaci di te',
          questions: [
            { id: 'q1_anni', text: 'Da quanti anni lavori come coach?', type: 'single', required: true, options: ['Meno di 1 anno', '1-3 anni', '3-5 anni', 'Pi√π di 5 anni'] },
            { id: 'q2_clienti', text: 'Quanti clienti attivi al mese?', type: 'single', required: true, options: ['1-5', '6-15', '16-30', 'Pi√π di 30'] },
            { id: 'q3_specializzazione', text: 'La tua specializzazione? (puoi selezionarne pi√π di una)', type: 'multi_with_other', required: true },
            { id: 'q4_fatturato', text: '% di fatturato da coaching derivante da clienti aziendali?', type: 'single', required: true, options: ['Meno del 50%', '50-80%', "Pi√π dell'80%"] }
          ]
        },
        {
          id: 'jtbd', title: 'Obiettivi', icon: 'Target', description: 'Cosa vuoi ottenere',
          questions: [
            { id: 'q5_obiettivo', text: 'Obiettivo principale nei prossimi 12 mesi?', type: 'single', required: true, options: ['Pi√π clienti', 'Pi√π valore per cliente', 'Meno tempo operativo', 'Modello scalabile', 'Risultati misurabili', 'Altro'] },
            { id: 'q6_ostacolo', text: 'Cosa ti impedisce di raggiungerlo?', type: 'textarea', required: true, placeholder: 'Descrivi il principale ostacolo...' }
          ]
        },
        {
          id: 'pain', title: 'Sfide', icon: 'Zap', description: 'Cosa ti frustra di pi√π',
          questions: [
            { id: 'q7_frustrazioni_ranking', text: 'Ordina per frustrazione (trascina: pi√π alta in cima)', type: 'ranking', required: true },
            { id: 'q7b_altra', text: 'Altra frustrazione?', type: 'text', required: false, placeholder: 'Opzionale...' },
            { id: 'q8_situazione', text: "Descrivi l'ultima volta che hai provato questa frustrazione", type: 'textarea', required: false, placeholder: 'Cosa √® successo?' },
            { id: 'q9_soluzione', text: 'Come hai provato a risolverla?', type: 'textarea', required: false, placeholder: 'Strumenti o metodi usati...' }
          ]
        },
        {
          id: 'acquisizione', title: 'Acquisizione', icon: 'Search', description: 'Come trovi clienti',
          questions: [
            { id: 'q10_piattaforme', text: 'Piattaforme usate e soddisfazione (1-10)', type: 'platform_grid', required: true },
            { id: 'q10b_manca', text: 'Cosa manca o va migliorato?', type: 'textarea', required: false, placeholder: 'Es. "LinkedIn non converte"...' }
          ]
        },
        {
          id: 'strumenti', title: 'Strumenti', icon: 'Wrench', description: 'Budget e tool',
          questions: [
            { id: 'q11_spesa', text: 'Quanto spendi mensilmente in tali servizi?', type: 'single', required: true, options: ['‚Ç¨0-50', '‚Ç¨51-150', '‚Ç¨151-300', 'Pi√π di ‚Ç¨300'] },
            { id: 'q12_abbandonato', text: 'Strumento abbandonato e perch√©?', type: 'text', required: false, placeholder: 'Es. "Ho smesso di usare X perch√©..."' }
          ]
        },
        {
          id: 'finale', title: 'Finale', icon: 'MessageCircle', description: 'Ultime domande',
          questions: [
            { id: 'q13_magico', text: 'Se potessi risolvere UN problema, quale?', type: 'text', required: true, placeholder: 'Il problema da eliminare...' },
            { id: 'q14_ricerca', text: 'Hai cercato soluzioni negli ultimi 3 mesi?', type: 'single', required: true, options: ['S√¨, ho provato tool/servizi', 'S√¨, ma nulla di adatto', 'No, mancanza di tempo', 'No, non urgente'] },
            { id: 'q15_altro', text: 'Altro da condividere?', type: 'textarea', required: false, placeholder: 'Qualsiasi pensiero...' },
            { id: 'q16_intervista', text: 'Disponibile per intervista 15 min?', type: 'single', required: true, options: ['S√¨', 'No'] },
            { id: 'q17_email', text: 'La tua email per l\'intervista', type: 'email', required: false, conditional: { question: 'q16_intervista', value: 'S√¨' }, placeholder: 'email@esempio.com' }
          ]
        }
      ];

      // Inizializzazione
      useEffect(function() {
        var init = async function() {
          setAnswers({ 
            q7_frustrazioni_ranking: frustrationOptions.slice(),
            q3_specializzazione: [],
            q10_piattaforme: {}
          });
          try {
            var res = await fetch(SUPABASE_URL + '/rest/v1/survey_responses?select=id&limit=1', {
              headers: { 'apikey': SUPABASE_ANON_KEY }
            });
            setConnected(res.ok);
          } catch (e) {
            setConnected(false);
          }
          setIsLoading(false);
        };
        init();
      }, []);

      // Carica risposte
      var loadResponses = async function() {
        try {
          var res = await fetch(SUPABASE_URL + '/rest/v1/survey_responses?order=created_at.desc', {
            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
          });
          if (res.ok) {
            var data = await res.json();
            setAllResponses(data.map(function(r) { 
              return Object.assign({}, r.answers, { id: r.id, created_at: r.created_at }); 
            }));
          }
        } catch (e) { console.error(e); }
      };

      // Salva risposta
      var saveResponse = async function(data) {
        setIsSaving(true);
        try {
          var res = await fetch(SUPABASE_URL + '/rest/v1/survey_responses', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify({ answers: data })
          });
          setIsSaving(false);
          return res.ok;
        } catch (e) {
          setIsSaving(false);
          return false;
        }
      };

      // Cancella tutto
      var clearAll = async function() {
        if (!confirm('Eliminare TUTTE le risposte? Questa azione √® irreversibile.')) return;
        try {
          await fetch(SUPABASE_URL + '/rest/v1/survey_responses?id=gt.0', {
            method: 'DELETE',
            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
          });
          setAllResponses([]);
        } catch (e) {}
      };

      var currentSectionData = sections[currentSection];
      var IconComponent = Icons[currentSectionData ? currentSectionData.icon : 'Users'] || Icons.Users;

      // Handlers
      var handleAnswer = function(id, value) {
        setAnswers(function(prev) { 
          var newAnswers = Object.assign({}, prev);
          newAnswers[id] = value;
          return newAnswers;
        });
      };

      var handleMultiSelect = function(option) {
        var current = answers.q3_specializzazione || [];
        var newSelection;
        if (current.indexOf(option) > -1) {
          newSelection = current.filter(function(o) { return o !== option; });
        } else {
          newSelection = current.concat([option]);
        }
        setAnswers(function(prev) {
          return Object.assign({}, prev, { q3_specializzazione: newSelection });
        });
      };

      var handlePlatformToggle = function(pid) {
        var current = answers.q10_piattaforme || {};
        var newPlatforms = Object.assign({}, current);
        if (newPlatforms[pid]) {
          delete newPlatforms[pid];
        } else {
          newPlatforms[pid] = { used: true, satisfaction: '', customText: '' };
        }
        setAnswers(function(prev) {
          return Object.assign({}, prev, { q10_piattaforme: newPlatforms });
        });
      };

      var handlePlatformSatisfaction = function(pid, sat) {
        var current = answers.q10_piattaforme || {};
        var numValue = sat === '' ? '' : Math.min(10, Math.max(1, parseInt(sat) || 1));
        var newPlatforms = Object.assign({}, current);
        newPlatforms[pid] = Object.assign({}, newPlatforms[pid], { satisfaction: numValue });
        setAnswers(function(prev) {
          return Object.assign({}, prev, { q10_piattaforme: newPlatforms });
        });
      };

      var handlePlatformCustomText = function(text) {
        var current = answers.q10_piattaforme || {};
        var newPlatforms = Object.assign({}, current);
        newPlatforms.altro = Object.assign({}, newPlatforms.altro, { customText: text });
        setAnswers(function(prev) {
          return Object.assign({}, prev, { q10_piattaforme: newPlatforms });
        });
      };

      // Drag & Drop
      var handleDragStart = function(e, index) {
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = 'move';
      };

      var handleDragOver = function(e, index) {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;
        setDragOverIndex(index);
      };

      var handleDragLeave = function() { setDragOverIndex(null); };

      var handleDrop = function(e, index) {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;
        var items = (answers.q7_frustrazioni_ranking || frustrationOptions).slice();
        var draggedItem = items[draggedIndex];
        items.splice(draggedIndex, 1);
        items.splice(index, 0, draggedItem);
        setAnswers(function(prev) { return Object.assign({}, prev, { q7_frustrazioni_ranking: items }); });
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      var handleDragEnd = function() { setDraggedIndex(null); setDragOverIndex(null); };

      var isQuestionVisible = function(q) {
        if (!q.conditional) return true;
        return answers[q.conditional.question] === q.conditional.value;
      };

      var isSectionComplete = function() {
        return currentSectionData.questions.every(function(q) {
          if (!isQuestionVisible(q) || !q.required) return true;
          if (q.type === 'ranking') return true;
          if (q.type === 'multi_with_other') {
            var selected = answers.q3_specializzazione || [];
            var altroText = answers.q3_specializzazione_altro || '';
            return selected.length > 0 || altroText.trim() !== '';
          }
          if (q.type === 'platform_grid') {
            return Object.keys(answers.q10_piattaforme || {}).length > 0;
          }
          var ans = answers[q.id];
          return ans && ans.toString().trim() !== '';
        });
      };

      var handleNext = async function() {
        if (currentSection < sections.length - 1) {
          setCurrentSection(function(prev) { return prev + 1; });
          window.scrollTo(0, 0);
        } else {
          var dataToSave = Object.assign({}, answers);
          if (updateEmail) dataToSave.update_email = updateEmail;
          dataToSave.timestamp = new Date().toISOString();
          var success = await saveResponse(dataToSave);
          if (success) setSubmitted(true);
          else alert('Errore nel salvataggio. Riprova.');
        }
      };

      var handlePrev = function() {
        if (currentSection > 0) {
          setCurrentSection(function(prev) { return prev - 1; });
          window.scrollTo(0, 0);
        }
      };

      var resetForm = function() {
        setAnswers({ 
          q7_frustrazioni_ranking: frustrationOptions.slice(),
          q3_specializzazione: [],
          q10_piattaforme: {}
        });
        setCurrentSection(0);
        setSubmitted(false);
        setUpdateEmail('');
      };

      var handleAdminLogin = function() {
        if (adminPassword === ADMIN_PASSWORD) {
          setAdminMode(true);
          setShowWelcome(false);
          setAdminError('');
          loadResponses();
        } else {
          setAdminError('Password errata');
        }
      };

      // Export CSV migliorato
      var exportCSV = function() {
        if (!allResponses.length) {
          alert('Nessuna risposta da esportare');
          return;
        }
        
        // Headers leggibili
        var csvHeaders = [
          'ID', 'Data', 'Anni Esperienza', 'Clienti/Mese', 'Specializzazioni', 'Specializzazione Altro',
          '% Clienti Aziendali', 'Obiettivo 12 Mesi', 'Ostacolo Principale',
          'Frustrazione 1', 'Frustrazione 2', 'Frustrazione 3', 'Frustrazione 4', 'Frustrazione 5', 'Frustrazione 6',
          'Altra Frustrazione', 'Situazione Frustrazione', 'Soluzione Tentata',
          'LinkedIn Organico', 'LinkedIn Ads', 'Instagram', 'Facebook', 'Passaparola', 'Directory', 'Marketplace', 'Sito SEO', 'Email Mkt', 'Eventi', 'Piattaforma Altro', 'Piattaforma Altro Nome',
          'Cosa Manca Piattaforme', 'Spesa Mensile', 'Strumento Abbandonato',
          'Problema Magico', 'Ricerca Soluzioni', 'Altro', 'Disponibile Intervista', 'Email Intervista', 'Email Aggiornamenti'
        ];
        
        var csvRows = [csvHeaders.join(';')];
        
        allResponses.forEach(function(r, idx) {
          var ranking = r.q7_frustrazioni_ranking || [];
          var plat = r.q10_piattaforme || {};
          
          var row = [
            idx + 1,
            r.created_at ? new Date(r.created_at).toLocaleDateString('it-IT') : '',
            r.q1_anni || '',
            r.q2_clienti || '',
            Array.isArray(r.q3_specializzazione) ? r.q3_specializzazione.join(', ') : '',
            r.q3_specializzazione_altro || '',
            r.q4_fatturato || '',
            r.q5_obiettivo || '',
            r.q6_ostacolo || '',
            ranking[0] || '', ranking[1] || '', ranking[2] || '', ranking[3] || '', ranking[4] || '', ranking[5] || '',
            r.q7b_altra || '',
            r.q8_situazione || '',
            r.q9_soluzione || '',
            plat.linkedin_organic ? plat.linkedin_organic.satisfaction : '',
            plat.linkedin_ads ? plat.linkedin_ads.satisfaction : '',
            plat.instagram ? plat.instagram.satisfaction : '',
            plat.facebook ? plat.facebook.satisfaction : '',
            plat.passaparola ? plat.passaparola.satisfaction : '',
            plat.directory ? plat.directory.satisfaction : '',
            plat.marketplace ? plat.marketplace.satisfaction : '',
            plat.sito_seo ? plat.sito_seo.satisfaction : '',
            plat.email_mkt ? plat.email_mkt.satisfaction : '',
            plat.eventi ? plat.eventi.satisfaction : '',
            plat.altro ? plat.altro.satisfaction : '',
            plat.altro ? plat.altro.customText || '' : '',
            r.q10b_manca || '',
            r.q11_spesa || '',
            r.q12_abbandonato || '',
            r.q13_magico || '',
            r.q14_ricerca || '',
            r.q15_altro || '',
            r.q16_intervista || '',
            r.q17_email || '',
            r.update_email || ''
          ];
          
          // Escape e formattazione
          var formattedRow = row.map(function(cell) {
            var str = String(cell);
            str = str.replace(/\n/g, ' ').replace(/\r/g, '');
            if (str.indexOf(';') > -1 || str.indexOf('"') > -1) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          });
          
          csvRows.push(formattedRow.join(';'));
        });
        
        var csvContent = '\uFEFF' + csvRows.join('\r\n');
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = 'coach-survey-' + new Date().toISOString().slice(0,10) + '.csv';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      var exportJSON = function() {
        if (!allResponses.length) {
          alert('Nessuna risposta da esportare');
          return;
        }
        var blob = new Blob([JSON.stringify(allResponses, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = 'coach-survey-' + new Date().toISOString().slice(0,10) + '.json';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      var copyLink = function() {
        navigator.clipboard.writeText(window.location.href);
        alert('Link copiato!');
      };

      // Calcola statistiche per i grafici
      var computeStats = function() {
        if (!allResponses.length) return null;
        
        // Anni esperienza
        var anniCount = {};
        allResponses.forEach(function(r) {
          var val = r.q1_anni || 'N/A';
          anniCount[val] = (anniCount[val] || 0) + 1;
        });
        
        // Obiettivi
        var obiettiviCount = {};
        allResponses.forEach(function(r) {
          var val = r.q5_obiettivo || 'N/A';
          obiettiviCount[val] = (obiettiviCount[val] || 0) + 1;
        });
        
        // Frustrazioni ranking
        var frustrationScores = {};
        allResponses.forEach(function(r) {
          var items = r.q7_frustrazioni_ranking || [];
          items.forEach(function(item, i) {
            frustrationScores[item] = (frustrationScores[item] || 0) + (6 - i);
          });
        });
        
        // Piattaforme
        var platUsage = {};
        var platSatisfaction = {};
        platforms.forEach(function(p) {
          platUsage[p.id] = 0;
          platSatisfaction[p.id] = { total: 0, count: 0 };
        });
        allResponses.forEach(function(r) {
          var plat = r.q10_piattaforme || {};
          Object.keys(plat).forEach(function(k) {
            if (platUsage[k] !== undefined) {
              platUsage[k]++;
              if (plat[k].satisfaction) {
                platSatisfaction[k].total += parseInt(plat[k].satisfaction) || 0;
                platSatisfaction[k].count++;
              }
            }
          });
        });
        
        // Spesa
        var spesaCount = {};
        allResponses.forEach(function(r) {
          var val = r.q11_spesa || 'N/A';
          spesaCount[val] = (spesaCount[val] || 0) + 1;
        });
        
        return {
          anni: Object.entries(anniCount).map(function(e) { return { label: e[0], value: e[1] }; }),
          obiettivi: Object.entries(obiettiviCount).map(function(e) { return { label: e[0], value: e[1] }; }).sort(function(a,b) { return b.value - a.value; }),
          frustrazioni: Object.entries(frustrationScores).map(function(e) { return { label: e[0], value: e[1] }; }).sort(function(a,b) { return b.value - a.value; }),
          piattaforme: platforms.map(function(p) {
            var avg = platSatisfaction[p.id].count > 0 ? (platSatisfaction[p.id].total / platSatisfaction[p.id].count).toFixed(1) : 0;
            return { label: p.name, value: platUsage[p.id], avg: avg };
          }).filter(function(p) { return p.value > 0; }).sort(function(a,b) { return b.value - a.value; }),
          spesa: Object.entries(spesaCount).map(function(e) { return { label: e[0], value: e[1] }; })
        };
      };

      // === RENDER ===

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
              <div className="text-emerald-600 mb-3"><Icons.Spinner /></div>
              <p className="text-gray-600">Connessione in corso...</p>
            </div>
          </div>
        );
      }

      // Welcome
      if (showWelcome && !adminMode) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md">
              <div className="text-center mb-6">
                <div className="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
                  <span className="text-emerald-600"><Icons.Target /></span>
                </div>
                <h1 className="text-xl sm:text-2xl font-bold text-gray-800">Pain Discovery</h1>
                <p className="text-emerald-600 font-medium">Coaching Professionals</p>
                <p className="text-gray-500 text-sm mt-2">~5 minuti per completare</p>
                <div className="mt-3 inline-block bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full">
                  üîí Questionario anonimizzato
                </div>
              </div>
              
              <button type="button" onClick={function() { setShowWelcome(false); }} className="w-full py-3 sm:py-4 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 active:bg-emerald-800 transition flex items-center justify-center gap-2">
                Inizia <Icons.ChevronRight />
              </button>
              
              <div className="mt-4 flex items-center justify-center gap-2 text-xs">
                <span className={connected ? "text-emerald-600" : "text-amber-600"}>
                  {connected ? "‚óè Database connesso" : "‚óã Database offline"}
                </span>
              </div>
              
              <div className="mt-6 pt-4 border-t">
                {!showLoginForm ? (
                  <button type="button" onClick={function() { setShowLoginForm(true); }} className="w-full py-2 text-gray-400 text-sm hover:text-gray-600 flex items-center justify-center gap-2">
                    <Icons.Lock /> Admin
                  </button>
                ) : (
                  <div className="space-y-3">
                    <input type="password" value={adminPassword} onChange={function(e) { setAdminPassword(e.target.value); }} onKeyDown={function(e) { if (e.key === 'Enter') handleAdminLogin(); }} placeholder="Password" className="w-full p-3 border-2 rounded-xl focus:border-emerald-500 outline-none" />
                    {adminError && <p className="text-red-500 text-sm text-center">{adminError}</p>}
                    <div className="flex gap-2">
                      <button type="button" onClick={function() { setShowLoginForm(false); setAdminPassword(''); }} className="flex-1 py-2 text-gray-600 rounded-xl hover:bg-gray-100">Annulla</button>
                      <button type="button" onClick={handleAdminLogin} className="flex-1 py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900">Accedi</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ADMIN DASHBOARD
      if (adminMode) {
        var stats = computeStats();
        
        return (
          <div className="min-h-screen bg-gray-900 text-white">
            {/* Header */}
            <div className="bg-gray-800 border-b border-gray-700 px-4 py-3 sticky top-0 z-20">
              <div className="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-3">
                <div className="flex items-center gap-3">
                  <span className="text-emerald-400"><Icons.BarChart /></span>
                  <h1 className="text-lg font-bold">Dashboard Risultati</h1>
                  <span className="bg-emerald-600 text-white text-xs px-2 py-1 rounded-full">{allResponses.length} risposte</span>
                </div>
                <div className="flex items-center gap-2">
                  <button type="button" onClick={loadResponses} className="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm flex items-center gap-1">
                    <Icons.Refresh /> Aggiorna
                  </button>
                  <button type="button" onClick={exportCSV} className="px-3 py-2 bg-emerald-600 rounded-lg hover:bg-emerald-500 text-sm flex items-center gap-1">
                    <Icons.Download /> CSV
                  </button>
                  <button type="button" onClick={exportJSON} className="px-3 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 text-sm flex items-center gap-1">
                    <Icons.Download /> JSON
                  </button>
                  <button type="button" onClick={function() { setAdminMode(false); setShowWelcome(true); setShowLoginForm(false); }} className="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 flex items-center gap-1 text-sm">
                    <Icons.ArrowLeft /> Esci
                  </button>
                </div>
              </div>
            </div>

            {/* Tab switcher */}
            <div className="bg-gray-800 border-b border-gray-700 px-4">
              <div className="max-w-7xl mx-auto flex gap-4">
                <button 
                  type="button"
                  onClick={function() { setAdminTab('table'); }}
                  className={'py-3 px-4 text-sm font-medium border-b-2 transition ' + (adminTab === 'table' ? 'border-emerald-500 text-emerald-400' : 'border-transparent text-gray-400 hover:text-white')}
                >
                  <span className="flex items-center gap-2"><Icons.Table /> Tabella Dati</span>
                </button>
                <button 
                  type="button"
                  onClick={function() { setAdminTab('charts'); }}
                  className={'py-3 px-4 text-sm font-medium border-b-2 transition ' + (adminTab === 'charts' ? 'border-emerald-500 text-emerald-400' : 'border-transparent text-gray-400 hover:text-white')}
                >
                  <span className="flex items-center gap-2"><Icons.BarChart /> Grafici</span>
                </button>
              </div>
            </div>

            <div className="p-4">
              <div className="max-w-7xl mx-auto">
                
                {allResponses.length === 0 ? (
                  <div className="bg-gray-800 rounded-xl p-12 text-center">
                    <span className="text-gray-600 block mb-3"><Icons.Database /></span>
                    <p className="text-gray-400 text-lg">Nessuna risposta ancora</p>
                    <p className="text-gray-500 text-sm mt-2">Condividi il link del questionario per iniziare a raccogliere risposte</p>
                  </div>
                ) : (
                  <>
                    {/* TAB: TABELLA */}
                    {adminTab === 'table' && (
                      <div className="bg-gray-800 rounded-xl overflow-hidden">
                        <div className="overflow-x-auto" style={{ maxHeight: '70vh' }}>
                          <table className="spreadsheet-table w-full text-sm">
                            <thead>
                              <tr>
                                <th className="text-gray-300">#</th>
                                {tableColumns.map(function(col) {
                                  return <th key={col.key} className="text-gray-300">{col.label}</th>;
                                })}
                              </tr>
                            </thead>
                            <tbody>
                              {allResponses.map(function(r, idx) {
                                return (
                                  <tr key={r.id || idx}>
                                    <td className="text-gray-400 font-mono">{idx + 1}</td>
                                    {tableColumns.map(function(col) {
                                      var value = r[col.key];
                                      var displayValue = col.format ? col.format(value) : (value || '-');
                                      var isLongText = typeof displayValue === 'string' && displayValue.length > 50;
                                      return (
                                        <td 
                                          key={col.key} 
                                          className="text-gray-200"
                                          style={{ maxWidth: isLongText ? '300px' : 'auto' }}
                                          title={isLongText ? displayValue : ''}
                                        >
                                          {isLongText ? displayValue.substring(0, 50) + '...' : displayValue}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}

                    {/* TAB: GRAFICI */}
                    {adminTab === 'charts' && stats && (
                      <div className="space-y-6">
                        {/* KPI Cards */}
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                          <div className="bg-gray-800 rounded-xl p-4 text-center">
                            <p className="text-gray-400 text-xs uppercase">Totale Risposte</p>
                            <p className="text-3xl font-bold text-emerald-400 mt-1">{allResponses.length}</p>
                          </div>
                          <div className="bg-gray-800 rounded-xl p-4 text-center">
                            <p className="text-gray-400 text-xs uppercase">Disponibili Intervista</p>
                            <p className="text-3xl font-bold text-blue-400 mt-1">{allResponses.filter(function(r) { return r.q16_intervista === 'S√¨'; }).length}</p>
                          </div>
                          <div className="bg-gray-800 rounded-xl p-4 text-center">
                            <p className="text-gray-400 text-xs uppercase">Con Email</p>
                            <p className="text-3xl font-bold text-purple-400 mt-1">{allResponses.filter(function(r) { return r.q17_email || r.update_email; }).length}</p>
                          </div>
                          <div className="bg-gray-800 rounded-xl p-4 text-center">
                            <p className="text-gray-400 text-xs uppercase">Esperti (3+ anni)</p>
                            <p className="text-3xl font-bold text-amber-400 mt-1">{allResponses.filter(function(r) { return r.q1_anni === '3-5 anni' || r.q1_anni === 'Pi√π di 5 anni'; }).length}</p>
                          </div>
                        </div>

                        {/* Grafici */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                          <HorizontalBarChart 
                            data={stats.frustrazioni} 
                            title="üî• Frustrazioni (per punteggio)" 
                            color="#ef4444"
                          />
                          <HorizontalBarChart 
                            data={stats.piattaforme.map(function(p) { return { label: p.label + ' (avg: ' + p.avg + ')', value: p.value }; })} 
                            title="üì± Piattaforme Utilizzate" 
                            color="#3b82f6"
                          />
                          <DonutChart 
                            data={stats.obiettivi} 
                            title="üéØ Obiettivi 12 Mesi" 
                          />
                          <DonutChart 
                            data={stats.anni} 
                            title="üìÖ Anni di Esperienza" 
                          />
                          <HorizontalBarChart 
                            data={stats.spesa} 
                            title="üí∞ Spesa Mensile in Strumenti" 
                            color="#10b981"
                          />
                        </div>
                      </div>
                    )}

                    {/* Footer azioni */}
                    <div className="mt-6 pt-4 border-t border-gray-700 flex justify-between items-center">
                      <p className="text-gray-500 text-sm">Ultimo aggiornamento: {new Date().toLocaleString('it-IT')}</p>
                      <button type="button" onClick={clearAll} className="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg text-sm hover:bg-red-600/30 flex items-center gap-2">
                        <Icons.Trash /> Elimina tutte le risposte
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      }

      // Submitted
      if (submitted) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md text-center">
              <div className="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span className="text-emerald-600"><Icons.Check /></span>
              </div>
              <h2 className="text-xl font-bold text-gray-800 mb-2">Grazie mille!</h2>
              <p className="text-gray-600 mb-4">Le tue risposte sono state salvate.</p>
              
              <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-6 text-left">
                <p className="text-emerald-800 text-sm">
                  üéØ Questa ricerca serve a creare una soluzione per risolvere i problemi che i coach ci hanno condiviso.
                </p>
              </div>

              <div className="space-y-4 mb-6">
                <div className="bg-gray-50 rounded-xl p-4">
                  <p className="text-gray-700 text-sm font-medium mb-2 flex items-center gap-2">
                    <Icons.Mail /> Vuoi rimanere aggiornato?
                  </p>
                  <input type="email" value={updateEmail} onChange={function(e) { setUpdateEmail(e.target.value); }} placeholder="Lascia la tua email" className="w-full p-2 border rounded-lg text-sm" />
                </div>
                <div className="bg-gray-50 rounded-xl p-4">
                  <p className="text-gray-700 text-sm font-medium mb-2 flex items-center gap-2">
                    <Icons.Share /> Vuoi contribuire?
                  </p>
                  <p className="text-gray-500 text-xs mb-2">Condividi questo questionario con i tuoi colleghi coach</p>
                  <button type="button" onClick={copyLink} className="w-full py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition">üìã Copia link</button>
                </div>
              </div>
              <button type="button" onClick={resetForm} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700">Compila un altro questionario</button>
            </div>
          </div>
        );
      }

      // Main Questionnaire
      return (
        <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-teal-100 p-3 sm:p-4">
          <div className="max-w-xl mx-auto">
            {/* Progress */}
            <div className="mb-4">
              <div className="flex justify-between mb-2">
                {sections.map(function(sec, i) {
                  var Icon = Icons[sec.icon] || Icons.Users;
                  return (
                    <div key={sec.id} className={'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center transition-all ' + (i === currentSection ? 'bg-emerald-600 text-white scale-110' : i < currentSection ? 'bg-emerald-200 text-emerald-700' : 'bg-gray-200 text-gray-400')}>
                      <Icon />
                    </div>
                  );
                })}
              </div>
              <div className="h-1.5 bg-gray-200 rounded-full">
                <div className="h-full bg-emerald-600 rounded-full transition-all" style={{ width: ((currentSection + 1) / sections.length * 100) + '%' }} />
              </div>
            </div>

            {/* Card */}
            <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="bg-emerald-600 text-white p-4 sm:p-5">
                <div className="flex items-center gap-2 mb-1"><IconComponent /><h2 className="text-lg font-semibold">{currentSectionData.title}</h2></div>
                <p className="text-emerald-100 text-sm">{currentSectionData.description}</p>
              </div>

              <div className="p-4 sm:p-6 space-y-5">
                {currentSectionData.questions.map(function(q) {
                  if (!isQuestionVisible(q)) return null;
                  
                  return (
                    <div key={q.id} className="space-y-2">
                      <label className="block font-medium text-gray-800 text-sm sm:text-base">
                        {q.text}{q.required && <span className="text-red-500 ml-1">*</span>}
                      </label>

                      {q.type === 'single' && (
                        <div className="space-y-2">
                          {q.options.map(function(opt) {
                            return (
                              <label key={opt} className={'flex items-center p-3 rounded-xl border-2 cursor-pointer transition-all ' + (answers[q.id] === opt ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200')}>
                                <input type="radio" className="sr-only" checked={answers[q.id] === opt} onChange={function() { handleAnswer(q.id, opt); }} />
                                <div className={'w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center flex-shrink-0 ' + (answers[q.id] === opt ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300')}>
                                  {answers[q.id] === opt && <div className="w-2 h-2 bg-white rounded-full" />}
                                </div>
                                <span className="text-gray-700 text-sm">{opt}</span>
                              </label>
                            );
                          })}
                        </div>
                      )}

                      {q.type === 'multi_with_other' && (
                        <div className="space-y-2">
                          {specializationOptions.map(function(opt) {
                            var isSelected = (answers.q3_specializzazione || []).indexOf(opt) > -1;
                            return (
                              <label key={opt} className={'flex items-center p-3 rounded-xl border-2 cursor-pointer transition-all ' + (isSelected ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200')}>
                                <input type="checkbox" className="sr-only" checked={isSelected} onChange={function() { handleMultiSelect(opt); }} />
                                <div className={'w-5 h-5 rounded border-2 mr-3 flex items-center justify-center flex-shrink-0 ' + (isSelected ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300')}>
                                  {isSelected && <span className="text-white"><Icons.CheckSmall /></span>}
                                </div>
                                <span className="text-gray-700 text-sm">{opt}</span>
                              </label>
                            );
                          })}
                          <div className={'p-3 rounded-xl border-2 transition-all ' + (answers.q3_specializzazione_altro ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200')}>
                            <div className="flex items-center">
                              <div className={'w-5 h-5 rounded border-2 mr-3 flex items-center justify-center flex-shrink-0 ' + (answers.q3_specializzazione_altro ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300')}>
                                {answers.q3_specializzazione_altro && <span className="text-white"><Icons.CheckSmall /></span>}
                              </div>
                              <span className="text-gray-700 text-sm">Altro:</span>
                            </div>
                            <input type="text" placeholder="Specifica..." value={answers.q3_specializzazione_altro || ''} onChange={function(e) { handleAnswer('q3_specializzazione_altro', e.target.value); }} className="mt-2 w-full p-2 border rounded-lg text-sm" />
                          </div>
                        </div>
                      )}

                      {q.type === 'ranking' && (
                        <div className="space-y-2">
                          <p className="text-xs text-gray-500">‚òùÔ∏è Trascina per riordinare</p>
                          {(answers.q7_frustrazioni_ranking || frustrationOptions).map(function(item, index) {
                            return (
                              <div
                                key={item + '-' + index}
                                draggable
                                onDragStart={function(e) { handleDragStart(e, index); }}
                                onDragOver={function(e) { handleDragOver(e, index); }}
                                onDragLeave={handleDragLeave}
                                onDrop={function(e) { handleDrop(e, index); }}
                                onDragEnd={handleDragEnd}
                                className={'flex items-center gap-2 p-2 sm:p-3 rounded-xl border-2 bg-white cursor-grab active:cursor-grabbing transition-all ' + (draggedIndex === index ? 'opacity-50 border-emerald-500' : dragOverIndex === index ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-gray-300')}
                              >
                                <span className="text-gray-400"><Icons.GripVertical /></span>
                                <span className={'w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 ' + (index === 0 ? 'bg-red-100 text-red-600' : index === 1 ? 'bg-orange-100 text-orange-600' : index === 2 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-500')}>{index + 1}</span>
                                <span className="text-gray-700 text-xs sm:text-sm flex-1">{item}</span>
                              </div>
                            );
                          })}
                        </div>
                      )}

                      {q.type === 'platform_grid' && (
                        <div className="space-y-2">
                          {platforms.map(function(p) {
                            var data = (answers.q10_piattaforme || {})[p.id];
                            var isUsed = !!data;
                            var isAltro = p.id === 'altro';
                            return (
                              <div key={p.id} className={'p-3 rounded-xl border-2 transition-all ' + (isUsed ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200')}>
                                <div className="flex items-center justify-between flex-wrap gap-2">
                                  <label className="flex items-center cursor-pointer flex-1 min-w-0">
                                    <input type="checkbox" className="sr-only" checked={isUsed} onChange={function() { handlePlatformToggle(p.id); }} />
                                    <div className={'w-5 h-5 rounded border-2 mr-2 flex items-center justify-center flex-shrink-0 ' + (isUsed ? 'border-emerald-500 bg-emerald-500' : 'border-gray-300')}>
                                      {isUsed && <span className="text-white"><Icons.CheckSmall /></span>}
                                    </div>
                                    <span className="text-gray-700 text-sm truncate">{p.name}</span>
                                  </label>
                                  {isUsed && (
                                    <input type="number" min="1" max="10" placeholder="1-10" value={data && data.satisfaction ? data.satisfaction : ''} onChange={function(e) { handlePlatformSatisfaction(p.id, e.target.value); }} className="w-16 border rounded-lg px-2 py-1 text-sm text-center" />
                                  )}
                                </div>
                                {isAltro && isUsed && (
                                  <input type="text" placeholder="Specifica quale piattaforma..." value={data && data.customText ? data.customText : ''} onChange={function(e) { handlePlatformCustomText(e.target.value); }} className="mt-2 w-full p-2 border rounded-lg text-sm" />
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}

                      {(q.type === 'text' || q.type === 'email') && (
                        <input type={q.type === 'email' ? 'email' : 'text'} value={answers[q.id] || ''} onChange={function(e) { handleAnswer(q.id, e.target.value); }} placeholder={q.placeholder} className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none transition text-sm" />
                      )}

                      {q.type === 'textarea' && (
                        <textarea value={answers[q.id] || ''} onChange={function(e) { handleAnswer(q.id, e.target.value); }} placeholder={q.placeholder} rows={3} className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none transition resize-none text-sm" />
                      )}
                    </div>
                  );
                })}
              </div>

              {/* Navigation */}
              <div className="p-4 sm:p-6 bg-gray-50 flex justify-between gap-3">
                <button type="button" onClick={handlePrev} disabled={currentSection === 0} className={'flex items-center gap-1 px-4 py-2.5 rounded-xl font-medium transition ' + (currentSection === 0 ? 'text-gray-300' : 'text-gray-600 hover:bg-gray-200')}><Icons.ChevronLeft /></button>
                <button type="button" onClick={handleNext} disabled={!isSectionComplete() || isSaving} className={'flex items-center gap-1 px-5 py-2.5 rounded-xl font-medium transition ' + (isSectionComplete() && !isSaving ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-gray-200 text-gray-400')}>
                  {isSaving ? <span className="animate-spin">‚Üª</span> : <>{currentSection === sections.length - 1 ? 'Invia' : 'Avanti'} <Icons.ChevronRight /></>}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
